// Generated by CoffeeScript 1.9.0

/*
https://spreadsheets.google.com/feeds/worksheets/{SHEET-ID}/public/basic?alt=json       get grid ids
https://spreadsheets.google.com/feeds/list/{SHEET-ID}/{GRID-ID}/public/values?alt=json  get whole sheet data
https://spreadsheets.google.com/feeds/cells/{SHEET-ID}/{GRID-ID}/public/values          get all cell data
alt=json                                                                                return json
alt=json-in-script&callback={CALLBACK}                                                  return data to callback function
 */
var UI, dataLoader, util,
  __hasProp = {}.hasOwnProperty;

util = (function() {
  function util() {}

  util.pop = function(obj) {
    var key, result;
    for (key in obj) {
      if (!__hasProp.call(obj, key)) continue;
      result = obj[key];
      if (!delete obj[key]) {
        throw new Error();
      }
      return result;
    }
  };

  util.cleanObject = function(obj) {
    return util.pop(util.pop(util.pop(obj)));
  };

  util.htmlEncode = function(html) {
    return document.createElement('a').appendChild(document.createTextNode(html)).parentNode.innerHTML;
  };

  util.highlight = function(keyword, msg) {
    var kw, _i, _len;
    if (Array.isArray(keyword)) {
      for (_i = 0, _len = keyword.length; _i < _len; _i++) {
        kw = keyword[_i];
        msg = msg.split(kw).join("<b>" + kw + "</b>");
      }
    } else {
      msg = msg.split(keyword).join("<b>" + keyword + "</b>");
    }
    return msg;
  };

  return util;

})();

dataLoader = (function() {
  function dataLoader() {}

  dataLoader.data = {
    totalQuestion: 0,
    totalPage: 0,
    loadQuestion: 0,
    loadedPage: 0,
    loadedType: 0,
    db: TAFFY()
  };

  dataLoader.load = function() {
    return $.ajax({
      url: "https://gist.githubusercontent.com/tony1223/098e45623c73274f7ae3/raw",
      crossDomain: true,
      dataType: "json"
    }).done(function(data) {
      dataLoader.data.db.insert(data.data);
      $("#load-count").text("最後更新 " + data.lastmodify);
      return dataLoader.list();
    });
  };

  dataLoader.list = function() {
    var html, result;
    result = dataLoader.data.db();
    html = "";
    result.each(function(r) {
      return html += "<tr><td>" + r['姓名'] + "</td><td>" + r['性別'] + "</td><td>" + r['國籍'] + " - " + r['縣市別'] + "</td><td>" + r['年齡'] + "</td><td>" + r['收治單位'] + "/" + r['醫療檢傷'] + "/" + r['救護檢傷'] + "</td><td>" + r['即時動向'] + "</td></tr>";
    });
    return $("#result").append(html);
  };

  dataLoader.init = function() {
    return this.load();
  };

  return dataLoader;

})();

UI = {
  init: function() {
    $("#btn-hide-footer").click(function() {
      return $("#footer").hide();
    });
    $(".form").submit(function(e) {
      e.preventDefault();
      return false;
    });
    $(".from-source").on("change", function() {
      return $("#inputKeyword").trigger("keyup");
    });
    return $("#inputKeyword").on("keyup", function() {
      var html, result, val;
      val = $(this).val();
      if (val.length <= 0) {
        return dataLoader.list();
      }
      $("#result").html("");
      val = val.toLowerCase();
      result = dataLoader.data.db({
        "姓名": val
      });
      html = "";
      result.each(function(r) {
        return html += "<tr><td>" + r['姓名'] + "</td><td>" + r['性別'] + "</td><td>" + r['國籍'] + " - " + r['縣市別'] + "</td><td>" + r['年齡'] + "</td><td>" + r['收治單位'] + "/" + r['醫療檢傷'] + "/" + r['救護檢傷'] + "</td><td>" + r['即時動向'] + "</td></tr>";
      });
      $("#result").append(html);
    });
  },
  loading: function(msg) {
    if (msg !== "") {
      $("#overlay-loading-content div").text(msg);
      $("#overlay-loading").show();
    } else {
      $("#overlay-loading").hide();
    }
  },
  updateNotification: function(msg) {
    return $("#loaded-count").text(msg);
  },
  updateProcessbar: function(msg, percent) {
    return $("#process-bar").text(msg).css("width", percent + "%");
  }
};

$(function() {
  dataLoader.init();
  return UI.init();
});
